<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰20å¤§å®¢æˆ·åˆ†æ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .upload-section {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }
        
        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
        }
        
        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-size: 0.9rem;
            color: #999;
        }
        
        #fileInput {
            display: none;
        }
        
        .file-info {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 8px;
            color: #2e7d32;
            display: none;
        }
        
        .result-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: none;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .result-title {
            font-size: 1.5rem;
            color: #333;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            margin-top: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        th:first-child { border-radius: 8px 0 0 0; }
        th:last-child { border-radius: 0 8px 0 0; }
        tr:hover { background: #f8f9ff; }
        
        .rank {
            width: 60px;
            text-align: center;
        }
        
        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .rank-1 { background: #ffd700; color: #333; }
        .rank-2 { background: #c0c0c0; color: #333; }
        .rank-3 { background: #cd7f32; color: white; }
        .rank-other { background: #e0e0e0; color: #666; }
        
        .amount { font-weight: 600; color: #2e7d32; }
        
        .customer-name {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .column-info {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin-top: 20px;
            border-radius: 0 8px 8px 0;
        }
        
        .column-info h4 { color: #e65100; margin-bottom: 10px; }
        .column-info ul { margin-left: 20px; color: #666; }

        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .percentage { color: #666; font-size: 0.85rem; }

        /* Loading Overlay */
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-content {
            background: white;
            padding: 40px 60px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            min-width: 400px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-step { font-size: 0.85rem; color: #999; margin-bottom: 8px; }
        .loading-text { font-size: 1.2rem; color: #333; margin-bottom: 10px; font-weight: 500; }
        .loading-progress { font-size: 0.9rem; color: #666; margin-bottom: 8px; min-height: 20px; }
        .loading-timer { font-size: 0.85rem; color: #999; margin-bottom: 20px; }

        .cancel-btn {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 8px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #666;
            transition: all 0.2s;
        }
        .cancel-btn:hover { background: #e0e0e0; color: #333; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š å‰20å¤§å®¢æˆ·åˆ†æ</h1>
        
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„</div>
                <div class="upload-hint">æ”¯æŒ .xlsx, .xls æ ¼å¼ï¼ˆæ”¯æŒå¤§æ–‡ä»¶ï¼‰</div>
            </div>
            <input type="file" id="fileInput" accept=".xlsx,.xls">
            <div class="file-info" id="fileInfo"></div>
            
            <div class="column-info">
                <h4>ğŸ“Œ æ‰€éœ€åˆ—åè¯´æ˜</h4>
                <ul>
                    <li><strong>å®¢æˆ·ç¼–ç </strong> - ç”¨äºè¯†åˆ«å”¯ä¸€å®¢æˆ·</li>
                    <li><strong>å®¢æˆ·åç§°</strong> - å®¢æˆ·æ˜¾ç¤ºåç§°ï¼ˆå¯é€‰ï¼‰</li>
                    <li><strong>æ”¯ä»˜é‡‘é¢</strong> - æ”¯ä»˜é‡‘é¢æ•°å€¼</li>
                    <li><strong>å……å€¼æŠµæ‰£</strong> - å……å€¼æŠµæ‰£é‡‘é¢</li>
                </ul>
                <p style="margin-top: 10px; color: #888;">ğŸ’¡ é‡‘é¢è®¡ç®—å…¬å¼ï¼šé‡‘é¢ = æ”¯ä»˜é‡‘é¢ + å……å€¼æŠµæ‰£</p>
            </div>
        </div>
        
        <div class="result-section" id="resultSection">
            <div class="result-header">
                <h2 class="result-title">ğŸ† å‰20å¤§å®¢æˆ·æ’è¡Œ</h2>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-label">å®¢æˆ·æ€»æ•°</div>
                        <div class="stat-value" id="totalCustomers">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æ€»é‡‘é¢</div>
                        <div class="stat-value" id="totalAmount">Â¥0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Top20å æ¯”</div>
                        <div class="stat-value" id="top20Percentage">0%</div>
                    </div>
                </div>
                <button class="export-btn" onclick="exportResult()">ğŸ“¥ å¯¼å‡ºç»“æœ</button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th class="rank">æ’å</th>
                            <th>å®¢æˆ·ç¼–ç </th>
                            <th>å®¢æˆ·åç§°</th>
                            <th>è®¢å•æ•°</th>
                            <th>æ”¯ä»˜é‡‘é¢</th>
                            <th>å……å€¼æŠµæ‰£</th>
                            <th>æ€»é‡‘é¢</th>
                            <th>å æ¯”</th>
                        </tr>
                    </thead>
                    <tbody id="resultTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-step" id="loadingStep">æ­¥éª¤ 1/4</div>
            <div class="loading-text" id="loadingText">æ­£åœ¨å¤„ç†...</div>
            <div class="progress-bar"><div class="progress-bar-fill" id="progressBarFill"></div></div>
            <div class="loading-progress" id="loadingProgress"></div>
            <div class="loading-timer" id="loadingTimer">å·²ç”¨æ—¶: 0ç§’</div>
            <button class="cancel-btn" onclick="cancelProcessing()">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- XLSXåº“ -->
    <script src="https://cdn.bootcdn.net/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        let processedData = [];
        let totalAmountAll = 0;
        let worker = null;
        let loadingStartTime = null;
        let loadingTimerInterval = null;
        let isCancelled = false;

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const resultSection = document.getElementById('resultSection');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // ========== Loading æ§åˆ¶ ==========
        function showLoading(step, text, progress = '', percent = 0) {
            isCancelled = false;
            loadingOverlay.style.display = 'flex';
            document.getElementById('loadingStep').textContent = step;
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingProgress').textContent = progress;
            document.getElementById('progressBarFill').style.width = percent + '%';
            
            if (!loadingStartTime) {
                loadingStartTime = Date.now();
                loadingTimerInterval = setInterval(updateTimer, 1000);
                updateTimer();
            }
            
            console.log(`[${step}] ${text} ${progress}`);
        }

        function updateTimer() {
            if (loadingStartTime) {
                const elapsed = Math.floor((Date.now() - loadingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timeStr = minutes > 0 ? `${minutes}åˆ†${seconds}ç§’` : `${seconds}ç§’`;
                document.getElementById('loadingTimer').textContent = `å·²ç”¨æ—¶: ${timeStr}`;
            }
        }

        function updateProgress(progress, percent) {
            document.getElementById('loadingProgress').textContent = progress;
            document.getElementById('progressBarFill').style.width = percent + '%';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
            loadingStartTime = null;
            if (loadingTimerInterval) {
                clearInterval(loadingTimerInterval);
                loadingTimerInterval = null;
            }
        }

        function cancelProcessing() {
            isCancelled = true;
            if (worker) {
                worker.terminate();
                worker = null;
            }
            hideLoading();
            console.log('ç”¨æˆ·å–æ¶ˆäº†å¤„ç†');
        }

        // ========== æ–‡ä»¶ä¸Šä¼ å¤„ç† ==========
        uploadArea.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
        });

        function handleFile(file) {
            const validExtensions = ['.xlsx', '.xls'];
            const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
            
            if (!validExtensions.includes(fileExtension)) {
                alert('è¯·ä¸Šä¼ Excelæ–‡ä»¶ï¼ˆ.xlsx æˆ– .xlsï¼‰');
                return;
            }

            const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
            fileInfo.style.display = 'block';
            fileInfo.innerHTML = `ğŸ“„ å·²é€‰æ‹©æ–‡ä»¶: <strong>${file.name}</strong> (${fileSizeMB}MB)`;

            console.log('========== å¼€å§‹å¤„ç†æ–‡ä»¶ ==========');
            console.log(`æ–‡ä»¶å: ${file.name}`);
            console.log(`æ–‡ä»¶å¤§å°: ${fileSizeMB}MB`);

            showLoading('æ­¥éª¤ 1/4', 'ğŸ“– è¯»å–æ–‡ä»¶...', `æ–‡ä»¶å¤§å°: ${fileSizeMB}MB`, 5);

            const reader = new FileReader();
            
            reader.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    const loadedMB = (e.loaded / 1024 / 1024).toFixed(2);
                    updateProgress(`è¯»å–è¿›åº¦: ${loadedMB}MB / ${fileSizeMB}MB`, percent * 0.2);
                }
            };

            reader.onload = (e) => {
                if (isCancelled) return;
                console.log('âœ“ æ–‡ä»¶è¯»å–å®Œæˆ');
                processWithWorker(e.target.result, fileSizeMB);
            };

            reader.onerror = () => {
                hideLoading();
                alert('æ–‡ä»¶è¯»å–å¤±è´¥');
            };

            reader.readAsArrayBuffer(file);
        }

        // ========== Web Worker å¤„ç† ==========
        function processWithWorker(arrayBuffer, fileSizeMB) {
            showLoading('æ­¥éª¤ 2/4', 'ğŸ“Š è§£æExcelï¼ˆåå°å¤„ç†ä¸­ï¼‰...', 'å¤§æ–‡ä»¶éœ€è¦1-3åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…...', 25);

            // åˆ›å»ºå†…è” Web Worker
            const workerCode = `
                importScripts('https://cdn.bootcdn.net/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');

                // å¿ƒè·³è®¡æ•°å™¨
                let heartbeatCount = 0;
                let heartbeatInterval = null;

                self.onmessage = function(e) {
                    const arrayBuffer = e.data;
                    const sizeMB = (arrayBuffer.byteLength / 1024 / 1024).toFixed(2);
                    
                    try {
                        self.postMessage({ type: 'log', message: '[Worker] æ”¶åˆ°æ•°æ®ï¼Œå¤§å°: ' + sizeMB + 'MB' });
                        self.postMessage({ type: 'status', step: '2/4', text: 'è§£æExcelå·¥ä½œç°¿...', percent: 30 });
                        
                        // å¯åŠ¨å¿ƒè·³ï¼Œæ¯3ç§’æŠ¥å‘Šä¸€æ¬¡
                        heartbeatInterval = setInterval(function() {
                            heartbeatCount++;
                            self.postMessage({ 
                                type: 'heartbeat', 
                                count: heartbeatCount,
                                message: '[Workerå¿ƒè·³ #' + heartbeatCount + '] æ­£åœ¨è§£æä¸­... (' + (heartbeatCount * 3) + 'ç§’)'
                            });
                        }, 3000);
                        
                        self.postMessage({ type: 'log', message: '[Worker] å¼€å§‹è§£æExcelï¼Œè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ...' });
                        
                        const startTime = Date.now();
                        const data = new Uint8Array(arrayBuffer);
                        
                        self.postMessage({ type: 'log', message: '[Worker] ArrayBufferè½¬æ¢å®Œæˆï¼Œå¼€å§‹XLSX.read()...' });
                        
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // åœæ­¢å¿ƒè·³
                        if (heartbeatInterval) {
                            clearInterval(heartbeatInterval);
                            heartbeatInterval = null;
                        }
                        
                        const parseTime = ((Date.now() - startTime) / 1000).toFixed(2);
                        self.postMessage({ type: 'log', message: '[Worker] âœ“ å·¥ä½œç°¿è§£æå®Œæˆï¼è€—æ—¶ ' + parseTime + 'ç§’' });
                        
                        self.postMessage({ type: 'status', step: '3/4', text: 'è½¬æ¢æ•°æ®æ ¼å¼...', percent: 50 });
                        self.postMessage({ type: 'log', message: '[Worker] å·¥ä½œè¡¨: ' + workbook.SheetNames.join(', ') });
                        
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        self.postMessage({ type: 'log', message: '[Worker] å¼€å§‹è½¬æ¢ä¸ºJSON...' });
                        const jsonStartTime = Date.now();
                        
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        const jsonTime = ((Date.now() - jsonStartTime) / 1000).toFixed(2);
                        self.postMessage({ type: 'log', message: '[Worker] âœ“ JSONè½¬æ¢å®Œæˆï¼Œè€—æ—¶ ' + jsonTime + 'ç§’' });
                        self.postMessage({ type: 'log', message: '[Worker] æ•°æ®è¡Œæ•°: ' + jsonData.length });
                        
                        if (jsonData.length === 0) {
                            self.postMessage({ type: 'error', message: 'Excelæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®' });
                            return;
                        }

                        // éªŒè¯åˆ—
                        const requiredColumns = ['å®¢æˆ·ç¼–ç ', 'æ”¯ä»˜é‡‘é¢', 'å……å€¼æŠµæ‰£'];
                        const firstRow = jsonData[0];
                        const columns = Object.keys(firstRow);
                        const missingColumns = requiredColumns.filter(col => !(col in firstRow));
                        
                        if (missingColumns.length > 0) {
                            self.postMessage({ 
                                type: 'error', 
                                message: 'ç¼ºå°‘å¿…éœ€çš„åˆ—: ' + missingColumns.join(', ') + '\\n\\nå½“å‰Excelçš„åˆ—å:\\n' + columns.join(', ')
                            });
                            return;
                        }

                        self.postMessage({ type: 'status', step: '4/4', text: 'åˆ†æå®¢æˆ·æ•°æ®...', percent: 60 });
                        self.postMessage({ type: 'log', message: '[Worker] å¼€å§‹åˆ†ç»„æ±‡æ€» ' + jsonData.length + ' è¡Œæ•°æ®...' });
                        
                        // åˆ†ç»„æ±‡æ€»
                        const customerMap = new Map();
                        const totalRows = jsonData.length;
                        const processStartTime = Date.now();
                        
                        for (let i = 0; i < totalRows; i++) {
                            const row = jsonData[i];
                            const customerCode = String(row['å®¢æˆ·ç¼–ç '] || '').trim();
                            if (!customerCode) continue;

                            const payAmount = parseFloat(row['æ”¯ä»˜é‡‘é¢']) || 0;
                            const rechargeDeduction = parseFloat(row['å……å€¼æŠµæ‰£']) || 0;
                            const totalAmount = payAmount + rechargeDeduction;
                            const customerName = row['å®¢æˆ·åç§°'] || row['å®¢æˆ·'] || '';

                            if (customerMap.has(customerCode)) {
                                const existing = customerMap.get(customerCode);
                                existing.payAmount += payAmount;
                                existing.rechargeDeduction += rechargeDeduction;
                                existing.totalAmount += totalAmount;
                                existing.orderCount += 1;
                                if (!existing.customerName && customerName) {
                                    existing.customerName = customerName;
                                }
                            } else {
                                customerMap.set(customerCode, {
                                    customerCode,
                                    customerName,
                                    payAmount,
                                    rechargeDeduction,
                                    totalAmount,
                                    orderCount: 1
                                });
                            }

                            // æ¯10000è¡ŒæŠ¥å‘Šè¿›åº¦
                            if (i % 10000 === 0) {
                                const progress = Math.round((i / totalRows) * 100);
                                const percent = 60 + (progress * 0.35);
                                self.postMessage({ 
                                    type: 'progress', 
                                    text: 'å¤„ç†è¿›åº¦: ' + progress + '% (' + i.toLocaleString() + '/' + totalRows.toLocaleString() + ' è¡Œ)',
                                    percent: percent
                                });
                            }
                        }

                        const processTime = ((Date.now() - processStartTime) / 1000).toFixed(2);
                        self.postMessage({ type: 'log', message: '[Worker] âœ“ åˆ†ç»„æ±‡æ€»å®Œæˆï¼Œè€—æ—¶ ' + processTime + 'ç§’' });
                        self.postMessage({ type: 'log', message: '[Worker] å‘ç° ' + customerMap.size + ' ä¸ªä¸åŒå®¢æˆ·' });
                        
                        self.postMessage({ type: 'status', step: '4/4', text: 'ç”Ÿæˆæ’è¡Œæ¦œ...', percent: 95 });
                        self.postMessage({ type: 'log', message: '[Worker] å¼€å§‹æ’åº...' });

                        // æ’åº
                        const customers = Array.from(customerMap.values());
                        customers.sort((a, b) => b.totalAmount - a.totalAmount);

                        // è®¡ç®—æ€»é‡‘é¢
                        const totalAmountAll = customers.reduce((sum, c) => sum + c.totalAmount, 0);

                        // å–å‰20å
                        const top20 = customers.slice(0, 20);
                        const top20Amount = top20.reduce((sum, c) => sum + c.totalAmount, 0);

                        const totalTime = ((Date.now() - startTime) / 1000).toFixed(2);
                        self.postMessage({ type: 'log', message: '[Worker] âœ“ å…¨éƒ¨å¤„ç†å®Œæˆï¼æ€»è€—æ—¶ ' + totalTime + 'ç§’' });

                        self.postMessage({ 
                            type: 'complete', 
                            data: {
                                top20: top20,
                                totalCustomers: customers.length,
                                totalAmountAll: totalAmountAll,
                                top20Amount: top20Amount,
                                totalTime: totalTime,
                                totalRows: totalRows
                            }
                        });

                    } catch (error) {
                        // åœæ­¢å¿ƒè·³
                        if (heartbeatInterval) {
                            clearInterval(heartbeatInterval);
                            heartbeatInterval = null;
                        }
                        self.postMessage({ type: 'log', message: '[Worker] âŒ å‘ç”Ÿé”™è¯¯: ' + error.message });
                        self.postMessage({ type: 'error', message: error.message });
                    }
                };
            `;

            const blob = new Blob([workerCode], { type: 'application/javascript' });
            const workerUrl = URL.createObjectURL(blob);
            
            worker = new Worker(workerUrl);

            worker.onmessage = function(e) {
                const msg = e.data;
                
                switch (msg.type) {
                    case 'status':
                        showLoading(`æ­¥éª¤ ${msg.step}`, msg.text, '', msg.percent);
                        break;
                    case 'progress':
                        updateProgress(msg.text, msg.percent);
                        break;
                    case 'log':
                        console.log('ğŸ“‹ ' + msg.message);
                        break;
                    case 'heartbeat':
                        // å¿ƒè·³æ¶ˆæ¯ - è¯æ˜Workerè¿˜åœ¨è¿è¡Œ
                        console.log('ğŸ’“ ' + msg.message);
                        document.getElementById('loadingProgress').textContent = 'å¿ƒè·³ #' + msg.count + ' - Workeræ­£åœ¨è¿è¡Œä¸­...';
                        break;
                    case 'error':
                        hideLoading();
                        alert(msg.message);
                        break;
                    case 'complete':
                        handleComplete(msg.data);
                        break;
                }
            };

            worker.onerror = function(error) {
                hideLoading();
                console.error('Workeré”™è¯¯:', error);
                alert('å¤„ç†å‡ºé”™: ' + error.message);
            };

            // å‘é€æ•°æ®ç»™Worker
            worker.postMessage(arrayBuffer, [arrayBuffer]);
        }

        function handleComplete(data) {
            processedData = data.top20;
            totalAmountAll = data.totalAmountAll;

            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('totalCustomers').textContent = data.totalCustomers.toLocaleString();
            document.getElementById('totalAmount').textContent = 'Â¥' + data.totalAmountAll.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('top20Percentage').textContent = data.totalAmountAll > 0 
                ? ((data.top20Amount / data.totalAmountAll) * 100).toFixed(2) + '%' 
                : '0%';

            // æ¸²æŸ“è¡¨æ ¼
            renderTable(data.top20);

            console.log('========== å¤„ç†å®Œæˆ ==========');
            console.log(`æ€»è€—æ—¶: ${data.totalTime}ç§’`);
            console.log(`æ•°æ®è¡Œæ•°: ${data.totalRows}`);
            console.log(`å®¢æˆ·æ€»æ•°: ${data.totalCustomers}`);
            console.log(`æ€»é‡‘é¢: Â¥${data.totalAmountAll.toLocaleString()}`);

            hideLoading();
            
            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth' });
            
            alert(`âœ… å¤„ç†å®Œæˆï¼\n\næ€»è€—æ—¶: ${data.totalTime}ç§’\næ•°æ®è¡Œæ•°: ${data.totalRows.toLocaleString()}\nå®¢æˆ·æ€»æ•°: ${data.totalCustomers.toLocaleString()}\næ€»é‡‘é¢: Â¥${data.totalAmountAll.toLocaleString('zh-CN', { minimumFractionDigits: 2 })}`);

            // æ¸…ç†Worker
            if (worker) {
                worker.terminate();
                worker = null;
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('resultTable');
            tbody.innerHTML = '';

            data.forEach((customer, index) => {
                const rank = index + 1;
                const percentage = totalAmountAll > 0 
                    ? ((customer.totalAmount / totalAmountAll) * 100).toFixed(2) 
                    : 0;

                let rankClass = 'rank-other';
                if (rank === 1) rankClass = 'rank-1';
                else if (rank === 2) rankClass = 'rank-2';
                else if (rank === 3) rankClass = 'rank-3';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="rank"><span class="rank-badge ${rankClass}">${rank}</span></td>
                    <td>${escapeHtml(customer.customerCode)}</td>
                    <td class="customer-name" title="${escapeHtml(customer.customerName)}">${escapeHtml(customer.customerName) || '-'}</td>
                    <td>${customer.orderCount.toLocaleString()}</td>
                    <td>Â¥${customer.payAmount.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td>Â¥${customer.rechargeDeduction.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="amount">Â¥${customer.totalAmount.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="percentage">${percentage}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function exportResult() {
            if (processedData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }

            const exportData = processedData.map((customer, index) => ({
                'æ’å': index + 1,
                'å®¢æˆ·ç¼–ç ': customer.customerCode,
                'å®¢æˆ·åç§°': customer.customerName,
                'è®¢å•æ•°': customer.orderCount,
                'æ”¯ä»˜é‡‘é¢': customer.payAmount,
                'å……å€¼æŠµæ‰£': customer.rechargeDeduction,
                'æ€»é‡‘é¢': customer.totalAmount,
                'å æ¯”': totalAmountAll > 0 ? ((customer.totalAmount / totalAmountAll) * 100).toFixed(2) + '%' : '0%'
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'å‰20å¤§å®¢æˆ·');

            ws['!cols'] = [
                { wch: 6 }, { wch: 15 }, { wch: 25 }, { wch: 10 },
                { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 10 }
            ];

            XLSX.writeFile(wb, 'Top20å®¢æˆ·åˆ†æç»“æœ.xlsx');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
